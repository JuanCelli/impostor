<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            text-align: center;
            padding: 2rem;
        }
        #tablePlayers {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            background: #1e1e1e;
        }
        button {
            margin-top: 1rem;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üéÆ Sala del Juego</h1>
    <p id="status">Conectando...</p>
    <div id="tablePlayers"></div>

    <!-- Solo visible si es admin -->
    <button id="nextRoundBtn" style="display:none;">‚û°Ô∏è Comenzar Ronda</button>
    <p id="character" style="display:none;">Esperando...</p>
    <p id="isFirst" style="display:none;">Te toca empezar</p>

    <script>
        window.addEventListener("load", () => {
            const playerName = prompt("Ingresa tu nombre");
            const ws = new WebSocket(`ws://localhost:8000/ws/${playerName}`);

            ws.onmessage = (event) => {
                let ws_data = JSON.parse(event.data)

                if (ws_data.code_ws_msj == 1){
                    const waitingState = ws_data.data;
                    console.log(waitingState)
                    updateWatingState(playerName, waitingState)
                }
                else if (ws_data.code_ws_msj == 2){
                    const gameState = ws_data.data;
                    console.log("Estado de juego recibido:", gameState);

                    if(gameState.is_impostor){
                        showImpostor();
                    } else {
                        showCharacter(gameState.character);
                    }

                    if(gameState.is_first){
                        document.getElementById("isFirst").style.display = "block";
                    } else {
                        document.getElementById("isFirst").style.display = "none";
                    }

                }


            };

            ws.onopen = () => {
                status.textContent = "‚úÖ Conectado al servidor";
            };

            ws.onclose = () => {
                status.textContent = "‚ùå Desconectado del servidor";
            };

            nextRoundBtn.addEventListener("click", () => {
                ws.send(JSON.stringify({ action: "next_round" }));
            });

        });

        const status = document.getElementById("status");
        const tablePlayers = document.getElementById("tablePlayers");
        const nextRoundBtn = document.getElementById("nextRoundBtn");
        const characterDisplay = document.getElementById("character");

        function showCharacter(character){
            characterDisplay.style.display = "block";
            characterDisplay.textContent = `Tu personaje es: ${character}`;
        }


        function showImpostor(){
            characterDisplay.style.display = "block";
            characterDisplay.textContent = `Sos el impostor! ü§´`;
        }

        function hideCharacter(){
            characterDisplay.style.display = "none";
            characterDisplay.textContent = `Esperando...`;
        }

        function hideIsFirst(){
            document.getElementById("isFirst").style.display = "none";
        }

        function clearPlayerTable(){
            const playersItems = document.querySelectorAll(".player");
            playersItems.forEach((item) => item.remove());
        }

        function updateWatingState(selfPlayerName,waitingState){
            let players = waitingState.players
            let quotaPlayers = waitingState.quota_players;
            let activePlayers = waitingState.active_players;


            clearPlayerTable();
            players.forEach((player) => {
                const p = document.createElement("p");
                p.classList.add("player");
                p.textContent = `üë§ ${player.name} - ${player.is_admin ? "Admin" : "Jugador"}`;
                tablePlayers.appendChild(p);
            });

            const isAdmin = players.find(p => p.name === selfPlayerName)?.is_admin;

            if (isAdmin && activePlayers == quotaPlayers) {
                nextRoundBtn.style.display = "inline-block";
            } else {
                nextRoundBtn.style.display = "none";
            }

        }







    </script>
</body>
</html>